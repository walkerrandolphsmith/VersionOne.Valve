<!DOCTYPE html>
  <html lang="en">
  <head>
      <title></title>
      <meta name="description" content="VersionOne.Valve Documentation" />
      <meta name="author" content="VersionOne.Valve" />
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="HandheldFriendly" content="True">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="referrer" content="no-referrer-when-downgrade">      <link rel="stylesheet" href="http://walkerrandolphsmith.com/VersionOne.Valve//css/styles.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" type="text/javascript"></script>
  </head>
  <body>
    <main class="page-wrapper">    <header class="navigation fixed">
        <div class="title">
            <a href="http://walkerrandolphsmith.com/VersionOne.Valve/">VersionOne.Valve</a>
        </div>
        <nav class="main light">
            <ul>
                <li><a href="http://walkerrandolphsmith.com/VersionOne.Valve/" title="Home">Home</a></li>
                <li><a href="http://walkerrandolphsmith.com/VersionOne.Valve//sdk" title="SDK">SDK</a></li><li><a href="http://walkerrandolphsmith.com/VersionOne.Valve//javascript" title="Javascript">Javascript</a></li><li><a href="http://walkerrandolphsmith.com/VersionOne.Valve//glance" title="Glance">Glance</a></li><li><a href="http://walkerrandolphsmith.com/VersionOne.Valve//utilities" title="Utilities">Utilities</a></li>
            </ul>
        </nav>    </header>
     <section id="article">
        <article class="post-contents">
        <h1></h1>
        <h2><a name="versionone-valve" class="anchor" href="#versionone-valve"></a>VersionOne.Valve</h2><p>Node application to pump data into a VersionOne instance.</p>
<h2><a name="global-install-coming-soon" class="anchor" href="#global-install-coming-soon"></a>Global install coming soon</h2><p>When published as a npm package it can be globally installed using
<code>npm i -g</code> and will have some added benefits.</p>
<ol>
<li>Run from any directory on your command line!</li>
<li>Forget about paths like <code>./node_modules/.bin/gulp</code> or <code>./bin/index.js</code> just type <code>valve &lt;command&gt; &lt;options&gt;</code></li>
</ol>
<h2><a name="setup" class="anchor" href="#setup"></a>Setup</h2><p>Clone the repo and run <code>npm run boot</code> within the directory.
On windows you may need to run terminal as admin.</p>
<p>That’s it. If you want more control you can check out Manual Setup at bottom.</p>
<h2><a name="run" class="anchor" href="#run"></a>Run</h2><p>Run a valve file (populate a feature)</p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">./bin/index.js run ./src/features/daag/index.js<span class="line-numbers-rows"><span></span></span></code></pre><i class="fa fa-copy"></i></div><h2><a name="new-features" class="anchor" href="#new-features"></a>New Features</h2><p>Valve concentrates on automating features of VersionOne instance as a collection of commands.
Therefore the directory structure models this by having a <code>features</code> directory,
such that each sub directory is a feature that contains a collection of commands.</p>
<p>Creating new features can be as easy as running:</p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">./bin/index.js template -f <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>feature</span><span class="token punctuation" >></span></span> -n <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>name</span><span class="token punctuation" >></span></span><span class="line-numbers-rows"><span></span></span></code></pre><i class="fa fa-copy"></i></div><ul>
<li><code>-f</code> or <code>--feature</code> Name of directory created under <code>./src/features</code></li>
<li><code>-n</code> or <code>--name</code> Name of file created under –feature directory</li>
</ul>
<h2><a name="directory-structure" class="anchor" href="#directory-structure"></a>Directory Structure</h2><div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">|-- .env                        # env vars used to declare VersionOne instance url
|-- valvefile
|-- bin
|   |--index                    # entry point to running commands
|   |--options                  # define the known command line flags
|   |--commands                 # commands that can be run
|-- package.json
|-- README.md
|-- src
|   |-- common                  # constants and fns used by any feature
|   |-- features                # collection of features
|   |   |-- daag                
|   |   |   |-- utils           # constants and fns used by this feature
|   |   |   |   |-- index.js
|   |   |   |-- index.js        # default valve file that can be run by cli
|   |   |   |-- S1234           # valve files that can be run by cli
|   |   |   |-- S2345           # ...<span class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><i class="fa fa-copy"></i></div><h2><a name="file-anatomy" class="anchor" href="#file-anatomy"></a>File Anatomy</h2><div class="code-wrapper"><pre class="language-js line-numbers"><code class="language-js line-numbers"><span class="token keyword" >import</span> throttler <span class="token keyword" >from</span> <span class="token string" >'./../../common/throttler'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> times <span class="token keyword" >from</span> <span class="token string" >'./../../common/times'</span><span class="token punctuation" >;</span>
<span class="token keyword" >const</span> Runner <span class="token operator" >=</span> <span class="token function" >require</span><span class="token punctuation" >(</span><span class="token string" >'./../../runner'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

module<span class="token punctuation" >.</span>exports <span class="token operator" >=</span> <span class="token keyword" >class</span> <span class="token class-name" >ValveRunner</span> <span class="token keyword" >extends</span> <span class="token class-name" >Runner</span> <span class="token punctuation" >{</span>
     <span class="token comment" spellcheck="true">/*
      *
      * Options are passed in from the command line.
      * Enrich your feature by providing command line options
      * Example of usage in ./src/features/member/index.js
      *
      */</span>
    <span class="token function" >constructor</span><span class="token punctuation" >(</span>options<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
        <span class="token keyword" >super</span><span class="token punctuation" >(</span>options<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span>

    <span class="token comment" spellcheck="true">/*
     * Command must be marked as async to use await within its scope
     */</span>
    <span class="token keyword" >async</span> <span class="token function" >command</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
        <span class="token comment" spellcheck="true">/*
        *
        * This function must return a Promise!
        *
        */</span>
        <span class="token keyword" >return</span> <span class="token keyword" >new</span> <span class="token class-name" >Promise</span><span class="token punctuation" >(</span><span class="token punctuation" >(</span>resolve<span class="token punctuation" >,</span> reject<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
            <span class="token comment" spellcheck="true">/*
            *
            * Get a reference to the V1 SDK as a user
            *
            */</span>
            <span class="token keyword" >const</span> v1 <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >authenticateAs</span><span class="token punctuation" >(</span><span class="token string" >'admin'</span><span class="token punctuation" >,</span> <span class="token string" >'admin'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

            <span class="token keyword" >const</span> results <span class="token operator" >=</span> v1<span class="token punctuation" >.</span><span class="token function" >query</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>
                    <span class="token keyword" >from</span><span class="token punctuation" >:</span> <span class="token string" >'PrimaryWorkitem'</span><span class="token punctuation" >,</span>
                    select<span class="token punctuation" >:</span> <span class="token punctuation" >[</span>
                        <span class="token string" >'Name'</span>
                    <span class="token punctuation" >]</span><span class="token punctuation" >,</span>
                    where<span class="token punctuation" >:</span> <span class="token punctuation" >{</span>
                        ID<span class="token punctuation" >:</span> <span class="token string" >'Story:8546'</span>
                    <span class="token punctuation" >}</span>
                <span class="token punctuation" >}</span><span class="token punctuation" >)</span>
                <span class="token punctuation" >.</span><span class="token function" >then</span><span class="token punctuation" >(</span>response <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
                    <span class="token comment" spellcheck="true">//axios stores the results you want in response.data</span>
                    console<span class="token punctuation" >.</span><span class="token function" >log</span><span class="token punctuation" >(</span>response<span class="token punctuation" >.</span>data<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
                <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >.</span><span class="token keyword" >catch</span><span class="token punctuation" >(</span><span class="token punctuation" >(</span>err<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
                    <span class="token function" >reject</span><span class="token punctuation" >(</span><span class="token string" >'error talking with V1'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
                <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

            <span class="token comment" spellcheck="true">/*
            *
            * Only so many HTTP requests can be handled by IIS at once so throttle them!
            *
            */</span>
            <span class="token keyword" >const</span> promisesInFlight <span class="token operator" >=</span> <span class="token number" >25</span><span class="token punctuation" >;</span>
            <span class="token keyword" >const</span> promises <span class="token operator" >=</span> <span class="token function" >times</span><span class="token punctuation" >(</span><span class="token number" >1000</span><span class="token punctuation" >)</span><span class="token punctuation" >.</span><span class="token function" >map</span><span class="token punctuation" >(</span>i <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> Promise<span class="token punctuation" >.</span><span class="token function" >resolve</span><span class="token punctuation" >(</span>i<span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
            <span class="token keyword" >const</span> resolvedValues <span class="token operator" >=</span> <span class="token keyword" >await</span> <span class="token function" >throttler</span><span class="token punctuation" >(</span>promises<span class="token punctuation" >,</span> promisesInFlight<span class="token punctuation" >)</span><span class="token punctuation" >;</span>

            <span class="token function" >resolve</span><span class="token punctuation" >(</span>resolvedValues<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
        <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span>
<span class="token punctuation" >}</span><span class="token punctuation" >;</span><span class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><i class="fa fa-copy"></i></div><h2><a name="manual-setup" class="anchor" href="#manual-setup"></a>Manual Setup</h2><p><code>npm run boot</code> does two things  </p>
<ol>
<li>Installs dependencies  </li>
<li>Creates a <code>.env</code> file with default values  </li>
</ol>
<p>We can does these steps manually as well with the following guide:</p>
<h3><a name="dependencies" class="anchor" href="#dependencies"></a>Dependencies</h3><p>Start by installing all dependencies:</p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">npm install<span class="line-numbers-rows"><span></span></span></code></pre><i class="fa fa-copy"></i></div><h3><a name="configure" class="anchor" href="#configure"></a>Configure</h3><p>Create a <code>.env</code> file in the root of the application to connect to VersionOne instance:</p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">V1Protocol=       //VersionOne instance's protocol
V1Port=           //VersionOne instance's port
V1Host=           //VersionOne instance's host
V1Instance=       //VersionOne instance's name
V1Username=       //VersionOne instance's user's username
V1Password=       //VersionOne instance's user's password
V1AccessToken=    //VersionOne instance's user's access token<span class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><i class="fa fa-copy"></i></div><h2><a name="contributors" class="anchor" href="#contributors"></a>Contributors</h2><p>When attempting to contribute to this project the following should be added to the <code>.env</code> file:</p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">V1Protocol=https
V1Port=443
V1Host=www14.v1host.com
V1Instance=v1sdktesting
V1AccessToken=Bearer 1.jA9m1Of4OUnAx/SCuOIGyE8DiCo=<span class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><i class="fa fa-copy"></i></div><h2><a name="issues" class="anchor" href="#issues"></a>Issues</h2><p>Issues can be found <a href="https://github.com/walkerrandolphsmith/VersionOne.Valve/issues">on github issues</a><br>Include <code>closes</code>, <code>fixes</code>, or <code>resolves</code> in a commit message to close the issue.
For example </p>
<div class="code-wrapper"><pre class="language-none line-numbers"><code class="language-none line-numbers">git commit -m "This closes #34, and closes #23"<span class="line-numbers-rows"><span></span></span></code></pre><i class="fa fa-copy"></i></div>
        </article>
        <div class="aside-wrapper">
            <aside class="natural">
                  <section id="toc">
                      <header>
                      <h3>In this Article</h3>
                      <i class="fa fa-plus expander"></i>
                      </header>
                      <ul>
                          <li>
                             <a href="/home#versionone.valve">VersionOne.Valve</a>
                          </li>
                          <li>
                             <a href="/home#global-install-coming-soon">Global install coming soon</a>
                          </li>
                          <li>
                             <a href="/home#setup">Setup</a>
                          </li>
                          <li>
                             <a href="/home#run">Run</a>
                          </li>
                          <li>
                             <a href="/home#new-features">New Features</a>
                          </li>
                          <li>
                             <a href="/home#directory-structure">Directory Structure</a>
                          </li>
                          <li>
                             <a href="/home#file-anatomy">File Anatomy</a>
                          </li>
                          <li>
                             <a href="/home#manual-setup">Manual Setup</a>
                          </li>
                          <li>
                             <a href="/home#dependencies">Dependencies</a>
                          </li>
                          <li>
                             <a href="/home#configure">Configure</a>
                          </li>
                          <li>
                             <a href="/home#contributors">Contributors</a>
                          </li>
                          <li>
                             <a href="/home#issues">Issues</a>
                          </li>
                      </ul>
                  </section>
            </aside>
        </div>
    </section>
    </section>
      </main>
      <footer class="main">
        <section class="made-by">
            <div class="main">Made with <i class="fa fa-heart"></i></div>
        </section>
        <ul class="social">

        </ul>
      </footer>
      <script src="http://walkerrandolphsmith.com/VersionOne.Valve//index.js" type="text/javascript"></script>
    </body>
  </html>